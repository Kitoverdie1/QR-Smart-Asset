import streamlit as st
import pandas as pd
from pathlib import Path

EXCEL_PATH = "Smart Asset Lab (2).xlsx"  # ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Home.py

# ----------------------------
# ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô
# ----------------------------
if "user" not in st.session_state:
    st.error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Home ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô")
    st.stop()

user = st.session_state["user"]

st.set_page_config(page_title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", page_icon="‚úèÔ∏è", layout="wide")

# ----------------------------
# helper ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Dashboard)
# ----------------------------
def go_to_page(page_path: str):
    """
    page_path ‡πÄ‡∏ä‡πà‡∏ô 'pages/1_asset_dashboard.py'
    """
    if hasattr(st, "switch_page"):
        st.switch_page(page_path)
    else:
        st.warning("‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Streamlit ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö switch_page ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô")


# ================================
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Excel
# ================================
@st.cache_data
def load_assets(path: str) -> pd.DataFrame:
    file = Path(path)
    if not file.exists():
        st.error(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel: {file.name}")
        st.stop()

    df = pd.read_excel(file)
    df = df.dropna(how="all").reset_index(drop=True)

    if "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢" in df.columns:
        df["‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢"] = pd.to_numeric(df["‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢"], errors="coerce")

    return df


def save_assets(df_to_save: pd.DataFrame, path: str):
    """
    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DataFrame ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà sheet ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
    (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô sheet ‡πÅ‡∏£‡∏Å)
    """
    file = Path(path)
    xls = pd.ExcelFile(file)
    first_sheet = xls.sheet_names[0]

    with pd.ExcelWriter(file, engine="openpyxl", mode="a", if_sheet_exists="replace") as writer:
        df_to_save.to_excel(writer, index=False, sheet_name=first_sheet)

    # ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    load_assets.clear()


# ================================
# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ================================
df = load_assets(EXCEL_PATH)

COL_NAME = "‡∏ä‡∏∑‡πà‡∏≠"
COL_CODE = "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£"
COL_ASSET_ID = "AssetID"
COL_STATUS = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"
COL_LOCATION = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)"

# ================================
# ‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô)
# ================================
nav_left, nav_right = st.columns([1.5, 1])

with nav_left:
    st.markdown(
        """
        <h2 style="margin-bottom:0.2rem;">
            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå
        </h2>
        """,
        unsafe_allow_html=True,
    )
    st.caption(
        "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏á Excel** ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á "
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á) ‡∏•‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel"
    )

with nav_right:
    st.markdown("<div style='text-align:right;'>", unsafe_allow_html=True)
    if st.button("üìä ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏™‡∏£‡∏∏‡∏õ", key="go_dashboard"):
        go_to_page("pages/1_asset_dashboard.py")
    st.markdown("</div>", unsafe_allow_html=True)

# ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡πÜ
info_col1, info_col2 = st.columns([4, 1.2])
with info_col2:
    st.markdown(
        f"""
        <div style="
            padding: 8px 12px;
            border-radius: 14px;
            background: #e3f2fd;
            margin-top: 4px;
        ">
            <div style="font-size:12px;color:#546e7a;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div style="font-size:13px;font-weight:600;color:#0d47a1;">
                {user.get("display_name","-")}
            </div>
            <div style="font-size:11px;color:#78909c;">({user.get("username","")})</div>
        </div>
        """,
        unsafe_allow_html=True
    )

st.markdown("---")

# ================================
# ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
# ================================
with st.expander("üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", expanded=True):
    col_f1, col_f2, col_f3 = st.columns([2, 1.2, 1.2])

    with col_f1:
        keyword = st.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™ / AssetID", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...").strip()

    with col_f2:
        locations = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] + sorted(df[COL_LOCATION].dropna().unique().tolist()) if COL_LOCATION in df.columns else ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]
        selected_location = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)", locations, index=0)

    with col_f3:
        if COL_STATUS in df.columns:
            statuses = df[COL_STATUS].dropna().unique().tolist()
        else:
            statuses = []
        selected_statuses = st.multiselect(
            "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå",
            options=statuses,
            default=statuses
        )

# ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
filtered_df = df.copy()

if keyword:
    kw = keyword.lower()
    mask = (
        filtered_df[COL_NAME].astype(str).str.lower().str.contains(kw)
        | filtered_df[COL_CODE].astype(str).str.lower().str.contains(kw)
        | filtered_df[COL_ASSET_ID].astype(str).str.lower().str.contains(kw)
    )
    filtered_df = filtered_df[mask]

if COL_LOCATION in df.columns and selected_location != "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":
    filtered_df = filtered_df[filtered_df[COL_LOCATION] == selected_location]

if COL_STATUS in df.columns and selected_statuses:
    filtered_df = filtered_df[filtered_df[COL_STATUS].isin(selected_statuses)]

st.caption(f"‡πÅ‡∏™‡∏î‡∏á {len(filtered_df):,} ‡πÅ‡∏ñ‡∏ß ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {len(df):,} ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel")

# ================================
# ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ================================
st.markdown("### ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á")

edited_df = st.data_editor(
    filtered_df,
    num_rows="fixed",         # ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå)
    use_container_width=True,
    height=500,
    key="asset_editor_table"
)

# ================================
# ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
# ================================
st.markdown("---")
save_col1, save_col2 = st.columns([1.3, 3])

with save_col1:
    if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏á Excel", type="primary", use_container_width=True):
        try:
            # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ df ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡∏ï‡∏≤‡∏° index ‡πÄ‡∏î‡∏¥‡∏°
            df_updated = df.copy()
            df_updated.loc[edited_df.index, :] = edited_df

            save_assets(df_updated, EXCEL_PATH)
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ")
        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")

with save_col2:
    st.caption("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)")
